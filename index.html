<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boris AI Ultra + Groq</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: Arial, sans-serif;
            background: #343541;
            color: #ececf1;
            height: 100vh;
            display: flex;
        }

        body.light {
            background: #f7f7f8;
            color: #202123;
        }

        .sidebar {
            width: 260px;
            background: #202123;
            border-right: 1px solid #565869;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        body.light .sidebar {
            background: #f0f0f0;
            border-right-color: #ddd;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #10a37f;
        }

        button {
            padding: 12px;
            margin: 5px 0;
            background: #10a37f;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover { background: #0d8c6d; }

        .menu-item {
            padding: 12px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover { background: rgba(255,255,255,0.1); }
        .menu-item.active { background: #10a37f; }

        body.light .menu-item:hover { background: rgba(0,0,0,0.1); }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .top-bar {
            padding: 15px 20px;
            background: #444654;
            border-bottom: 1px solid #565869;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.light .top-bar {
            background: #fff;
            border-bottom-color: #ddd;
        }

        .top-bar button {
            width: 40px;
            height: 40px;
            padding: 0;
            margin: 0 5px;
            background: transparent;
            border: 1px solid #565869;
            font-size: 18px;
        }

        body.light .top-bar button {
            border-color: #ddd;
            color: #202123;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .welcome {
            max-width: 800px;
            margin: 50px auto;
            text-align: center;
        }

        .welcome h1 {
            font-size: 32px;
            color: #10a37f;
            margin-bottom: 20px;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .card {
            padding: 20px;
            background: #444654;
            border: 1px solid #565869;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
        }

        body.light .card {
            background: #fff;
            border-color: #ddd;
        }

        .card:hover {
            background: rgba(16,163,127,0.1);
            border-color: #10a37f;
        }

        .card-icon { font-size: 40px; margin-bottom: 10px; }

        .message {
            max-width: 800px;
            margin: 0 auto 20px;
            display: flex;
        }

        .user-msg { justify-content: flex-end; }

        .msg-bubble {
            padding: 15px 20px;
            border-radius: 12px;
            max-width: 80%;
            line-height: 1.6;
        }

        .user-msg .msg-bubble {
            background: #10a37f;
            color: white;
        }

        .ai-msg .msg-bubble {
            background: #444654;
            border: 1px solid #565869;
        }

        body.light .ai-msg .msg-bubble {
            background: #fff;
            border-color: #ddd;
            color: #202123;
        }

        .input-area {
            padding: 20px;
            background: #444654;
            border-top: 1px solid #565869;
        }

        body.light .input-area {
            background: #fff;
            border-top-color: #ddd;
        }

        .input-box {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
        }

        textarea {
            flex: 1;
            padding: 15px;
            background: #343541;
            border: 2px solid #565869;
            border-radius: 12px;
            color: #ececf1;
            font-size: 15px;
            resize: none;
            min-height: 50px;
            font-family: Arial;
        }

        body.light textarea {
            background: #f7f7f8;
            border-color: #ddd;
            color: #202123;
        }

        textarea:focus {
            outline: none;
            border-color: #10a37f;
        }

        .send-btn {
            width: 50px;
            height: 50px;
            padding: 0;
            font-size: 20px;
        }

        .typing {
            display: flex;
            gap: 5px;
            padding: 15px;
        }

        .typing span {
            width: 8px;
            height: 8px;
            background: #10a37f;
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }

        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .notif {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #444654;
            border: 1px solid #565869;
            border-radius: 10px;
            z-index: 9999;
        }

        body.light .notif {
            background: #fff;
            border-color: #ddd;
            color: #202123;
        }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .cards { grid-template-columns: 1fr; }
        }

        /* Modal for API Key */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: #444654;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        body.light .modal-content {
            background: #fff;
            color: #202123;
        }

        .modal-content h2 {
            color: #10a37f;
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #565869;
            border-radius: 8px;
            background: #343541;
            color: #ececf1;
            font-size: 14px;
        }

        body.light .modal-content input {
            background: #f7f7f8;
            border-color: #ddd;
            color: #202123;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #10a37f;
        }

        .modal-content p {
            font-size: 14px;
            color: #acacbe;
            margin: 15px 0;
        }

        .modal-content a {
            color: #10a37f;
        }

        .api-status {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 20px;
            margin-left: 10px;
        }

        .api-status.connected {
            background: rgba(16, 163, 127, 0.2);
            color: #10a37f;
        }

        .api-status.disconnected {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
        }

        .model-select {
            padding: 8px 12px;
            background: #343541;
            border: 1px solid #565869;
            border-radius: 8px;
            color: #ececf1;
            font-size: 14px;
            cursor: pointer;
        }

        body.light .model-select {
            background: #f7f7f8;
            border-color: #ddd;
            color: #202123;
        }

        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        code {
            font-family: 'Consolas', monospace;
            font-size: 14px;
        }

        body.light pre {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <!-- API Key Modal -->
    <div class="modal" id="apiModal">
        <div class="modal-content">
            <h2>üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Groq API</h2>
            <p>–î–ª—è —Ä–∞–±–æ—Ç—ã AI –Ω—É–∂–µ–Ω –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API –∫–ª—é—á –æ—Ç Groq</p>
            <input type="password" id="apiKeyInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Groq API Key (gsk_...)">
            <p>
                <a href="https://console.groq.com/keys" target="_blank">üëâ –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–∞ console.groq.com</a>
            </p>
            <button onclick="saveApiKey()" style="width: 100%; margin-top: 10px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeModal()" style="width: 100%; background: #565869;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo">ü§ñ Boris AI</div>
        <button onclick="newChat()">+ –ù–æ–≤—ã–π —á–∞—Ç</button>

        <div class="menu-item active" onclick="goHome()">
            <span>üè†</span>
            <span>–ì–ª–∞–≤–Ω–∞—è</span>
        </div>
        <div class="menu-item" onclick="ask('–ö–∞–∫–æ–π —Å–µ–π—á–∞—Å –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –∫ —É–∑–±–µ–∫—Å–∫–æ–º—É —Å—É–º—É?')">
            <span>üí∞</span>
            <span>–ö—É—Ä—Å—ã –≤–∞–ª—é—Ç</span>
        </div>
        <div class="menu-item" onclick="ask('–ö–∞–∫–∞—è —Å–µ–π—á–∞—Å –ø–æ–≥–æ–¥–∞ –≤ –¢–∞—à–∫–µ–Ω—Ç–µ?')">
            <span>üå§Ô∏è</span>
            <span>–ü–æ–≥–æ–¥–∞</span>
        </div>
        <div class="menu-item" onclick="ask('–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞')">
            <span>üì∞</span>
            <span>–ù–æ–≤–æ—Å—Ç–∏</span>
        </div>
        <div class="menu-item" onclick="ask('–í–æ —Å–∫–æ–ª—å–∫–æ —Å–µ–≥–æ–¥–Ω—è –Ω–∞–º–∞–∑ –≤ –¢–∞—à–∫–µ–Ω—Ç–µ?')">
            <span>üïå</span>
            <span>–ù–∞–º–∞–∑</span>
        </div>
        <div class="menu-item" onclick="ask('–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –º–µ—Ç—Ä–æ –¢–∞—à–∫–µ–Ω—Ç–∞')">
            <span>üöá</span>
            <span>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</span>
        </div>
        <div class="menu-item" onclick="openApiModal()">
            <span>‚öôÔ∏è</span>
            <span>API –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
    </div>

    <div class="main">
        <div class="top-bar">
            <div style="display: flex; align-items: center;">
                <span style="font-size: 18px; font-weight: bold;">Boris AI Ultra</span>
                <span class="api-status disconnected" id="apiStatus">–ù–µ—Ç API</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <select class="model-select" id="modelSelect" onchange="saveModel()">
                    <option value="llama-3.3-70b-versatile">LLaMA 3.3 70B</option>
                    <option value="llama-3.1-8b-instant">LLaMA 3.1 8B (Fast)</option>
                    <option value="mixtral-8x7b-32768">Mixtral 8x7B</option>
                    <option value="gemma2-9b-it">Gemma 2 9B</option>
                </select>
                <button onclick="refresh()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
                <button onclick="toggleTheme()" title="–¢–µ–º–∞">üåô</button>
                <button onclick="openApiModal()" title="API">üîë</button>
                <button onclick="ask('–ü–æ–º–æ–≥–∏ –º–Ω–µ, —á—Ç–æ —Ç—ã —É–º–µ–µ—à—å?')" title="–ü–æ–º–æ—â—å">‚ùì</button>
            </div>
        </div>

        <div class="messages" id="messages">
            <div class="welcome" id="welcome">
                <div style="font-size: 60px; margin-bottom: 20px;">ü§ñ</div>
                <h1>–ê—Å—Å–∞–ª–æ–º—É –∞–ª–µ–π–∫—É–º!</h1>
                <p style="color: #acacbe; margin-bottom: 10px;">
                    –Ø Boris AI ‚Äî —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞ –±–∞–∑–µ <strong>Groq + LLaMA</strong>!
                </p>
                <p style="color: #ff6464; margin-bottom: 30px;" id="apiWarning">
                    ‚ö†Ô∏è –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ‚öôÔ∏è API –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á
                </p>

                <div class="cards">
                    <div class="card" onclick="ask('–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞')">
                        <div class="card-icon">üíª</div>
                        <h3>–ö–æ–¥</h3>
                        <p style="font-size: 13px; color: #acacbe;">–ù–∞–ø–∏—à—É –∫–æ–¥ –Ω–∞ –ª—é–±–æ–º —è–∑—ã–∫–µ</p>
                    </div>

                    <div class="card" onclick="ask('–û–±—ä—è—Å–Ω–∏ –∫–≤–∞–Ω—Ç–æ–≤—É—é —Ñ–∏–∑–∏–∫—É –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏')">
                        <div class="card-icon">üß†</div>
                        <h3>–û–±—ä—è—Å–Ω–µ–Ω–∏—è</h3>
                        <p style="font-size: 13px; color: #acacbe;">–û–±—ä—è—Å–Ω—é —Å–ª–æ–∂–Ω–æ–µ –ø—Ä–æ—Å—Ç–æ</p>
                    </div>

                    <div class="card" onclick="ask('–ù–∞–ø–∏—à–∏ —ç—Å—Å–µ –ø—Ä–æ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç')">
                        <div class="card-icon">‚úçÔ∏è</div>
                        <h3>–¢–µ–∫—Å—Ç—ã</h3>
                        <p style="font-size: 13px; color: #acacbe;">–ù–∞–ø–∏—à—É –ª—é–±–æ–π —Ç–µ–∫—Å—Ç</p>
                    </div>

                    <div class="card" onclick="ask('–ü–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π: –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω')">
                        <div class="card-icon">üåç</div>
                        <h3>–ü–µ—Ä–µ–≤–æ–¥</h3>
                        <p style="font-size: 13px; color: #acacbe;">–ü–µ—Ä–µ–≤–µ–¥—É –Ω–∞ –ª—é–±–æ–π —è–∑—ã–∫</p>
                    </div>
                </div>

                <p style="color: #acacbe; font-size: 14px; margin-top: 30px;">
                    üí° <strong>Groq</strong> ‚Äî —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π AI –≤ –º–∏—Ä–µ! –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–æ 30 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω
                </p>
            </div>
        </div>

        <div class="input-area">
            <div class="input-box">
                <textarea id="input" placeholder="–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å..." onkeydown="checkEnter(event)"></textarea>
                <button class="send-btn" onclick="send()">‚û§</button>
            </div>
            <div style="text-align: center; color: #acacbe; font-size: 12px; margin-top: 10px;">
                Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å | Shift+Enter ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ | Powered by Groq LLaMA
            </div>
        </div>
    </div>

    <script>
        console.log('Boris AI Ultra + Groq –∑–∞–≥—Ä—É–∂–µ–Ω');

        // ==================== CONFIGURATION ====================
        let GROQ_API_KEY = localStorage.getItem('groq_api_key') || '';
        let selectedModel = localStorage.getItem('groq_model') || 'llama-3.3-70b-versatile';
        let isDarkTheme = localStorage.getItem('theme') !== 'light';
        let conversationHistory = [];

        // System prompt for Boris AI
        const SYSTEM_PROMPT = `–¢—ã ‚Äî Boris AI, —É–º–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–∞.

–¢–≤–æ–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- –û—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–µ—Å–ª–∏ –Ω–µ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–Ω–∞—á–µ)
- –ó–Ω–∞–µ—à—å –ø—Ä–æ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω, –µ–≥–æ –∫—É–ª—å—Ç—É—Ä—É, –≥–æ—Ä–æ–¥–∞, —Ç—Ä–∞–¥–∏—Ü–∏–∏
- –ú–æ–∂–µ—à—å –ø–∏—Å–∞—Ç—å –∫–æ–¥, –æ–±—ä—è—Å–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –≤–µ—â–∏, –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å
- –û—Ç–≤–µ—á–∞–µ—à—å –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ
- –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω, –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –Ω–∞ "–≤—ã"

–ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ –∫—É—Ä—Å –≤–∞–ª—é—Ç, –ø–æ–≥–æ–¥—É, –≤—Ä–µ–º—è –Ω–∞–º–∞–∑–∞ ‚Äî –æ—Ç–≤–µ—á–∞–π —á—Ç–æ —É —Ç–µ–±—è –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –Ω–æ –º–æ–∂–µ—à—å –¥–∞—Ç—å –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved settings
            document.getElementById('modelSelect').value = selectedModel;

            if (!isDarkTheme) {
                document.body.classList.add('light');
            }

            updateApiStatus();

            // Show modal if no API key
            if (!GROQ_API_KEY) {
                setTimeout(() => openApiModal(), 1000);
            }
        });

        // ==================== GROQ API ====================
        async function callGroqAPI(userMessage) {
            if (!GROQ_API_KEY) {
                return '‚ùå API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!\n\n–ù–∞–∂–º–∏—Ç–µ ‚öôÔ∏è **API –ù–∞—Å—Ç—Ä–æ–π–∫–∏** –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é –∏ –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à Groq API –∫–ª—é—á.\n\nüëâ –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ: [console.groq.com/keys](https://console.groq.com/keys)';
            }

            // Add user message to history
            conversationHistory.push({
                role: 'user',
                content: userMessage
            });

            // Keep only last 20 messages to avoid token limit
            if (conversationHistory.length > 20) {
                conversationHistory = conversationHistory.slice(-20);
            }

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${GROQ_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: selectedModel,
                        messages: [
                            { role: 'system', content: SYSTEM_PROMPT },
                            ...conversationHistory
                        ],
                        temperature: 0.7,
                        max_tokens: 4096,
                        stream: false
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));

                    if (response.status === 401) {
                        return '‚ùå **–ù–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á!**\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à Groq API –∫–ª—é—á –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.\n\nüëâ –ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π: [console.groq.com/keys](https://console.groq.com/keys)';
                    }

                    if (response.status === 429) {
                        return '‚è≥ **–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤!**\n\n–ü–æ–¥–æ–∂–¥–∏—Ç–µ –º–∏–Ω—É—Ç—É –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.\n\n–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç: ~30 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É';
                    }

                    throw new Error(errorData.error?.message || `HTTP ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                // Add assistant response to history
                conversationHistory.push({
                    role: 'assistant',
                    content: assistantMessage
                });

                return assistantMessage;

            } catch (error) {
                console.error('Groq API Error:', error);

                if (error.message.includes('Failed to fetch')) {
                    return '‚ùå **–û—à–∏–±–∫–∞ —Å–µ—Ç–∏!**\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                }

                return `‚ùå **–û—à–∏–±–∫–∞ API:**\n\n${error.message}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API –∫–ª—é—á\n‚Ä¢ –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å\n‚Ä¢ –ü–æ–¥–æ–∂–¥–∞—Ç—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å`;
            }
        }

        // ==================== UI FUNCTIONS ====================
        async function send() {
            const input = document.getElementById('input');
            const text = input.value.trim();

            if (!text) return;

            addUserMsg(text);
            input.value = '';
            input.style.height = '50px';

            showTyping();

            try {
                const response = await callGroqAPI(text);
                hideTyping();
                addAIMsg(response);
            } catch (error) {
                hideTyping();
                addAIMsg('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            }
        }

        function ask(question) {
            document.getElementById('input').value = question;
            send();
        }

        function addUserMsg(text) {
            const welcome = document.getElementById('welcome');
            if (welcome) welcome.style.display = 'none';

            const div = document.createElement('div');
            div.className = 'message user-msg';
            div.innerHTML = '<div class="msg-bubble">' + escapeHtml(text) + '</div>';
            document.getElementById('messages').appendChild(div);
            scroll();
        }

        function addAIMsg(text) {
            const div = document.createElement('div');
            div.className = 'message ai-msg';

            // Format markdown
            let formatted = formatMarkdown(text);

            div.innerHTML = '<div class="msg-bubble">' + formatted + '</div>';
            document.getElementById('messages').appendChild(div);
            scroll();
        }

        function formatMarkdown(text) {
            // Code blocks with syntax highlighting
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code class="language-${lang || 'text'}">${escapeHtml(code.trim())}</code></pre>`;
            });

            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code style="background:#1e1e1e;padding:2px 6px;border-radius:4px;">$1</code>');

            // Bold
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // Italic
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // Links
            text = text.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" style="color:#10a37f;">$1</a>');

            // Line breaks
            text = text.replace(/\n/g, '<br>');

            return text;
        }

        function showTyping() {
            const div = document.createElement('div');
            div.id = 'typing';
            div.className = 'message ai-msg';
            div.innerHTML = '<div class="msg-bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
            document.getElementById('messages').appendChild(div);
            scroll();
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        function scroll() {
            const msgs = document.getElementById('messages');
            setTimeout(() => msgs.scrollTop = msgs.scrollHeight, 50);
        }

        function checkEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                send();
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== CHAT MANAGEMENT ====================
        function newChat() {
            const msgs = document.getElementById('messages');
            const welcome = document.getElementById('welcome');

            const allMsgs = msgs.querySelectorAll('.message');
            allMsgs.forEach(m => m.remove());

            welcome.style.display = 'block';
            conversationHistory = [];
            notify('‚ú® –ù–æ–≤—ã–π —á–∞—Ç —Å–æ–∑–¥–∞–Ω');
        }

        function goHome() {
            newChat();
        }

        function refresh() {
            location.reload();
        }

        // ==================== SETTINGS ====================
        function openApiModal() {
            document.getElementById('apiModal').classList.add('show');
            document.getElementById('apiKeyInput').value = GROQ_API_KEY;
        }

        function closeModal() {
            document.getElementById('apiModal').classList.remove('show');
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();

            if (key && !key.startsWith('gsk_')) {
                notify('‚ö†Ô∏è API –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å gsk_');
                return;
            }

            GROQ_API_KEY = key;
            localStorage.setItem('groq_api_key', key);
            updateApiStatus();
            closeModal();

            if (key) {
                notify('‚úÖ API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
            } else {
                notify('üóëÔ∏è API –∫–ª—é—á —É–¥–∞–ª—ë–Ω');
            }
        }

        function saveModel() {
            selectedModel = document.getElementById('modelSelect').value;
            localStorage.setItem('groq_model', selectedModel);
            notify('‚úÖ –ú–æ–¥–µ–ª—å: ' + selectedModel.split('-')[0]);
        }

        function updateApiStatus() {
            const status = document.getElementById('apiStatus');
            const warning = document.getElementById('apiWarning');

            if (GROQ_API_KEY) {
                status.textContent = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                status.className = 'api-status connected';
                if (warning) warning.style.display = 'none';
            } else {
                status.textContent = 'üî¥ –ù–µ—Ç API';
                status.className = 'api-status disconnected';
                if (warning) warning.style.display = 'block';
            }
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('light', !isDarkTheme);
            localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
            notify(isDarkTheme ? 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞' : '‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞');
        }

        function notify(msg) {
            const old = document.querySelector('.notif');
            if (old) old.remove();

            const div = document.createElement('div');
            div.className = 'notif';
            div.textContent = msg;
            document.body.appendChild(div);

            setTimeout(() => div.remove(), 3000);
        }

        // Auto-resize textarea
        document.getElementById('input').addEventListener('input', function() {
            this.style.height = '50px';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Close modal on outside click
        document.getElementById('apiModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Startup
        setTimeout(() => {
            if (GROQ_API_KEY) {
                notify('üöÄ Boris AI –≥–æ—Ç–æ–≤! –ú–æ–¥–µ–ª—å: ' + selectedModel.split('-')[0]);
            }
        }, 500);
    </script>
</body>
</html>
